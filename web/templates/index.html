<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anima Voice Emotion</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body {
            background: #121212;
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .card {
            background: #1e1e1e;
            border-radius: 10px;
            border: 1px solid #333;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .card-header {
            background: #252525;
            border-bottom: 1px solid #333;
        }
        
        .emotion-badge {
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: 600;
            margin: 0 5px;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
        }
        
        .emotion-happy {
            background: rgba(255, 193, 7, 0.25);
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.5);
        }
        
        .emotion-sad {
            background: rgba(13, 110, 253, 0.25);
            color: #0d6efd;
            border: 1px solid rgba(13, 110, 253, 0.5);
        }
        
        .emotion-angry {
            background: rgba(220, 53, 69, 0.25);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.5);
        }
        
        .emotion-neutral {
            background: rgba(173, 181, 189, 0.25);
            color: #adb5bd;
            border: 1px solid rgba(173, 181, 189, 0.5);
        }
        
        .emotion-surprised {
            background: rgba(25, 135, 84, 0.25);
            color: #198754;
            border: 1px solid rgba(25, 135, 84, 0.5);
        }
        
        .emotion-fearful {
            background: rgba(111, 66, 193, 0.25);
            color: #6f42c1;
            border: 1px solid rgba(111, 66, 193, 0.5);
        }
        
        .emotion-disgusted {
            background: rgba(102, 16, 242, 0.25);
            color: #6610f2;
            border: 1px solid rgba(102, 16, 242, 0.5);
        }
        
        .main-header {
            background: linear-gradient(135deg, #1e1e1e 0%, #252525 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        
        .audio-visualizer {
            height: 100px;
            background: #252525;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
        }
        
        .audio-bar {
            position: absolute;
            bottom: 0;
            width: 3px;
            margin-right: 1px;
            background: linear-gradient(to top, #0d6efd, #6610f2);
            border-radius: 2px 2px 0 0;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        
        .status-active {
            background-color: #20c997;
            box-shadow: 0 0 10px #20c997;
            animation: pulse 1.5s infinite;
        }
        
        .status-inactive {
            background-color: #dc3545;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(32, 201, 151, 0.7);
            }
            70% {
                box-shadow: 0 0 0 6px rgba(32, 201, 151, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(32, 201, 151, 0);
            }
        }
        
        .btn-monitor {
            background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%);
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }
        
        .btn-monitor:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .btn-monitor.stop {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
        }
        
        .emotion-chart-container {
            height: 200px;
            position: relative;
            margin-bottom: 20px;
        }
        
        .history-item {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #252525;
            border-left: 4px solid #0d6efd;
            animation: fadeIn 0.5s;
        }
        
        .history-time {
            font-size: 0.8rem;
            color: #adb5bd;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .confidence-meter {
            height: 6px;
            background: #252525;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .confidence-level {
            height: 100%;
            background: linear-gradient(90deg, #0d6efd, #6610f2);
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        .emotion-icon {
            font-size: 2rem;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="main-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-microphone-alt me-2"></i> Anima Voice Emotion</h1>
                    <p class="lead mb-0">Real-time voice emotion detection and visualization</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="d-flex justify-content-md-end align-items-center">
                        <span class="me-2">Status:</span>
                        <span id="status-indicator" class="status-indicator status-inactive"></span>
                        <span id="status-text" class="me-3">Inactive</span>
                        <button id="toggleMonitoring" class="btn btn-monitor">
                            <i class="fas fa-play me-2"></i> Start
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- Current Emotion Panel -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="fas fa-face-grin me-2"></i> Current Emotion</h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-4">
                            <div id="current-emotion-icon" class="emotion-icon">
                                <i class="fas fa-face-meh fa-4x text-secondary"></i>
                            </div>
                            <h3 id="current-emotion">Waiting for voice...</h3>
                            <div id="confidence-meter" class="confidence-meter">
                                <div id="confidence-level" class="confidence-level" style="width: 0%"></div>
                            </div>
                            <small id="confidence-text" class="text-muted">Confidence: 0%</small>
                        </div>
                        
                        <div class="audio-visualizer" id="audio-visualizer">
                            <!-- Audio bars will be added dynamically -->
                        </div>
                    </div>
                </div>
                
                <!-- Emotion Distribution -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="fas fa-chart-pie me-2"></i> Emotion Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div class="emotion-chart-container">
                            <canvas id="emotionDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Emotion History & Trend -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0"><i class="fas fa-history me-2"></i> Emotion History</h5>
                        <button class="btn btn-sm btn-outline-secondary" id="clearHistory">Clear</button>
                    </div>
                    <div class="card-body">
                        <div class="emotion-chart-container">
                            <canvas id="emotionTrendChart"></canvas>
                        </div>
                        
                        <div class="mt-3" id="emotion-history">
                            <div class="text-center text-muted">
                                <i class="fas fa-microphone-slash me-2"></i> No emotion data yet
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Connect to Socket.IO server
        const socket = io();
        
        // Chart configuration
        let distributionChart = null;
        let trendChart = null;
        const emotionColors = {
            'happy': 'rgba(255, 193, 7, 0.8)',
            'sad': 'rgba(13, 110, 253, 0.8)',
            'angry': 'rgba(220, 53, 69, 0.8)',
            'neutral': 'rgba(173, 181, 189, 0.8)',
            'surprised': 'rgba(25, 135, 84, 0.8)',
            'fearful': 'rgba(111, 66, 193, 0.8)',
            'disgusted': 'rgba(102, 16, 242, 0.8)'
        };
        
        const emotionIcons = {
            'happy': '<i class="fas fa-face-grin fa-4x text-warning"></i>',
            'sad': '<i class="fas fa-face-sad-tear fa-4x text-primary"></i>',
            'angry': '<i class="fas fa-face-angry fa-4x text-danger"></i>',
            'neutral': '<i class="fas fa-face-meh fa-4x text-secondary"></i>',
            'surprised': '<i class="fas fa-face-surprise fa-4x text-success"></i>',
            'fearful': '<i class="fas fa-face-dizzy fa-4x text-purple"></i>',
            'disgusted': '<i class="fas fa-face-grimace fa-4x text-indigo"></i>'
        };
        
        // Global state
        let isMonitoring = false;
        let emotionHistory = [];
        
        // Initialize charts
        function initializeCharts() {
            // Distribution chart
            const distributionCtx = document.getElementById('emotionDistributionChart').getContext('2d');
            distributionChart = new Chart(distributionCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(emotionColors),
                    datasets: [{
                        data: [0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: Object.values(emotionColors),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#e0e0e0'
                            }
                        }
                    }
                }
            });
            
            // Trend chart
            const trendCtx = document.getElementById('emotionTrendChart').getContext('2d');
            trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            ticks: {
                                color: '#e0e0e0'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#e0e0e0',
                                maxTicksLimit: 5
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // Audio visualizer
        function setupAudioVisualizer() {
            const visualizer = document.getElementById('audio-visualizer');
            const barCount = 50;
            
            // Create bars
            for (let i = 0; i < barCount; i++) {
                const bar = document.createElement('div');
                bar.className = 'audio-bar';
                bar.style.left = `${i * 4}px`;
                bar.style.height = '0px';
                visualizer.appendChild(bar);
            }
            
            // Animate bars
            function animateBars() {
                if (!isMonitoring) {
                    const bars = visualizer.querySelectorAll('.audio-bar');
                    bars.forEach(bar => {
                        bar.style.height = '0px';
                    });
                    return;
                }
                
                const bars = visualizer.querySelectorAll('.audio-bar');
                bars.forEach(bar => {
                    const height = isMonitoring ? Math.random() * 100 : 0;
                    bar.style.height = `${height}px`;
                });
                
                requestAnimationFrame(animateBars);
            }
            
            animateBars();
        }
        
        // Format time difference
        function formatTimeDiff(timestamp) {
            const now = Date.now() / 1000;
            const diff = Math.round(now - timestamp);
            
            if (diff < 60) {
                return `${diff} sec ago`;
            } else if (diff < 3600) {
                return `${Math.floor(diff / 60)} min ago`;
            } else {
                return `${Math.floor(diff / 3600)} hr ago`;
            }
        }
        
        // Update emotion distribution chart
        function updateDistributionChart() {
            if (!emotionHistory.length || !distributionChart) return;
            
            // Count emotions
            const counts = {
                'happy': 0,
                'sad': 0,
                'angry': 0,
                'neutral': 0,
                'surprised': 0,
                'fearful': 0,
                'disgusted': 0
            };
            
            emotionHistory.forEach(item => {
                const emotion = item.dominant_emotion;
                if (emotion in counts) {
                    counts[emotion]++;
                }
            });
            
            // Update chart data
            distributionChart.data.datasets[0].data = Object.values(counts);
            distributionChart.update();
        }
        
        // Update emotion trend chart
        function updateTrendChart() {
            if (!emotionHistory.length || !trendChart) return;
            
            // Get the last 10 entries or less
            const entries = emotionHistory.slice(-10);
            const labels = entries.map((item, index) => `${index + 1}`);
            
            // Create datasets for each emotion
            const datasets = [];
            const emotions = ['happy', 'sad', 'angry', 'neutral', 'surprised', 'fearful', 'disgusted'];
            
            emotions.forEach(emotion => {
                const data = entries.map(entry => {
                    return entry.all_emotions && entry.all_emotions[emotion] 
                        ? entry.all_emotions[emotion] 
                        : 0;
                });
                
                // Only add emotions that have some data
                if (data.some(val => val > 0)) {
                    datasets.push({
                        label: emotion,
                        data: data,
                        borderColor: emotionColors[emotion],
                        backgroundColor: emotionColors[emotion].replace('0.8', '0.2'),
                        fill: false,
                        tension: 0.4
                    });
                }
            });
            
            // Update chart
            trendChart.data.labels = labels;
            trendChart.data.datasets = datasets;
            trendChart.update();
        }
        
        // Add emotion to history UI
        function addEmotionToHistoryUI(emotionData) {
            const historyContainer = document.getElementById('emotion-history');
            
            // Remove placeholder if present
            const placeholder = historyContainer.querySelector('.text-muted');
            if (placeholder) {
                historyContainer.innerHTML = '';
            }
            
            // Create history item
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            
            const emotion = emotionData.dominant_emotion;
            const confidence = (emotionData.confidence * 100).toFixed(0);
            const time = formatTimeDiff(emotionData.timestamp);
            
            historyItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <span>
                        <span class="emotion-badge emotion-${emotion}">${emotion}</span>
                        <span class="ms-2">${confidence}% confident</span>
                    </span>
                    <span class="history-time">${time}</span>
                </div>
            `;
            
            // Add to container (at the top)
            historyContainer.insertBefore(historyItem, historyContainer.firstChild);
            
            // Limit items
            if (historyContainer.children.length > 10) {
                historyContainer.removeChild(historyContainer.lastChild);
            }
        }
        
        // Update current emotion display
        function updateCurrentEmotion(emotionData) {
            const emotionElement = document.getElementById('current-emotion');
            const iconElement = document.getElementById('current-emotion-icon');
            const confidenceLevel = document.getElementById('confidence-level');
            const confidenceText = document.getElementById('confidence-text');
            
            const emotion = emotionData.dominant_emotion;
            const confidence = emotionData.confidence * 100;
            
            // Update UI elements
            emotionElement.textContent = emotion.charAt(0).toUpperCase() + emotion.slice(1);
            iconElement.innerHTML = emotionIcons[emotion] || emotionIcons.neutral;
            confidenceLevel.style.width = `${confidence}%`;
            confidenceText.textContent = `Confidence: ${confidence.toFixed(0)}%`;
        }
        
        // Socket.IO event handlers
        socket.on('connect', () => {
            console.log('Connected to server');
            
            // Initialize UI
            initializeCharts();
            setupAudioVisualizer();
            
            // Get initial history
            fetch('/api/emotions/history')
                .then(response => response.json())
                .then(data => {
                    emotionHistory = data;
                    
                    // Update charts
                    updateDistributionChart();
                    updateTrendChart();
                    
                    // Update history UI
                    emotionHistory.forEach(item => {
                        addEmotionToHistoryUI(item);
                    });
                });
            
            // Check status
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    isMonitoring = data.monitoring_active;
                    updateMonitoringUI();
                });
        });
        
        socket.on('emotion_update', (data) => {
            // Add to history
            emotionHistory.push(data);
            if (emotionHistory.length > 50) {
                emotionHistory.shift();
            }
            
            // Update UI
            updateCurrentEmotion(data);
            addEmotionToHistoryUI(data);
            updateDistributionChart();
            updateTrendChart();
        });
        
        socket.on('monitoring_status', (data) => {
            isMonitoring = data.active;
            updateMonitoringUI();
        });
        
        // Update UI based on monitoring status
        function updateMonitoringUI() {
            const toggleButton = document.getElementById('toggleMonitoring');
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            
            if (isMonitoring) {
                toggleButton.innerHTML = '<i class="fas fa-stop me-2"></i> Stop';
                toggleButton.classList.add('stop');
                statusIndicator.className = 'status-indicator status-active';
                statusText.textContent = 'Active';
            } else {
                toggleButton.innerHTML = '<i class="fas fa-play me-2"></i> Start';
                toggleButton.classList.remove('stop');
                statusIndicator.className = 'status-indicator status-inactive';
                statusText.textContent = 'Inactive';
            }
        }
        
        // Event listeners
        document.getElementById('toggleMonitoring').addEventListener('click', () => {
            const event = isMonitoring ? 'stop_monitoring' : 'start_monitoring';
            socket.emit(event);
        });
        
        document.getElementById('clearHistory').addEventListener('click', () => {
            emotionHistory = [];
            document.getElementById('emotion-history').innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-microphone-slash me-2"></i> No emotion data yet
                </div>
            `;
            updateDistributionChart();
            updateTrendChart();
        });
    </script>
</body>
</html>
